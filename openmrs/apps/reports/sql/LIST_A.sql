SELECT pi.identifier as NID,CONCAT(COALESCE(pn.given_name,''),' ', COALESCE(pn.middle_name,''),' ',COALESCE(pn.family_name,'')) as "Full Name",TIMESTAMPDIFF(YEAR, p.birthdate, CURDATE()) as AGE, type_of_registration.registration_type AS "Registration Type",
p.date_created as "Registration Date", CONCAT('ACTIVE IN ',p_state.patient_status) as "Patient State",p_state.date_created as "Patient State Date", p_status.patient_status as "Patient Status", p_status.p_status_date as "Patient Status Date" from person p
join person_name pn  on p.person_id = pn.person_id
join patient_identifier pi on pi.patient_id = pn.person_id
join (SELECT person_id, cn.name as registration_type FROM person_attribute pa JOIN person_attribute_type pat on pa.person_attribute_type_id= pat.person_attribute_type_id JOIN concept_name cn ON cn.concept_id = pa.value AND cn.locale="en" AND  cn.concept_name_type = "FULLY_SPECIFIED" AND pat.name = "TYPE_OF_REGISTRATION") type_of_registration ON type_of_registration.person_id = p.person_id
JOIN (SELECT person_id, cn.name as patient_status, pa.date_created as p_status_date FROM person_attribute pa JOIN person_attribute_type pat on pa.person_attribute_type_id= pat.person_attribute_type_id JOIN concept_name cn on cn.concept_id = pa.value AND cn.locale="en" AND  cn.concept_name_type = "FULLY_SPECIFIED" AND pat.name = "PATIENT_STATUS") p_status ON p_status.person_id= p.person_id
JOIN (SELECT patient_id,date_created,patient_status FROM patient_status_state WHERE id IN (SELECT MAX(id) FROM patient_status_state GROUP BY patient_id)) p_state ON p_state.patient_id= p.person_id